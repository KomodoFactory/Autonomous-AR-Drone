<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

    <style type="text/css" media="screen">
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #DDDDDD;
            color: #fff;
            font-family: Helvetica, Arial, "MS Trebuchet", sans-serif;
        }

        #pngStream {
            height: 640px;
            width: 640px;
            float: left;
        }

        #pngStreamCanvas {
            height: 640px;
            width: 640px;
        }

        #data, #controls {
            width: 50%;
            float: left;
        }

        .section {
            width: 33%;
            float: left;
        }

        .section button {
            padding: 5px;
            background: #fff;
            border: none;
            min-width: 100px;
            cursor: pointer;
        }

        .section button:active {
            background: #7FF2F6;
        }

    </style>
</head>

<body>
<div id='pngStream'>
    <canvas id="pngStreamCanvas" width=640 height=640></canvas>
</div>

<div id='controls'>
    <div class='section'>
        <button id='takeoff'>Takeoff</button>
        <br/>
        <button id='land'>Land</button>
        <br/>
        <button id='reset'>Reset</button>
    </div>
    <div class='section'>
        <button id='search'>Start Search</button>
        <br/>
        <button id='track'>Track Picture</button>
    </div>


</div>
<div id='data'>
    <div id="drone-position">
        <br/>Battery:
        <span class='battery'>0</span>%
    </div>
</div>

<script src="jquery.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="tracking/build/tracking-min.js"></script>


<script>
    var socket = io.connect('/');
    var canvas = document.getElementById('pngStreamCanvas');
    var context = canvas.getContext("2d");
    var img = new Image();


    $(function () {
        $('#takeoff').click(function () {
            socket.emit('takeoff')
        })
        $('#land').click(function () {
            socket.emit('land')
        })
        $('#reset').click(function () {
            socket.emit('reset')
        })
        $('#save').click(function () {
            socket.emit('FuckMe')
        })

    })

    socket.on('connect', function () {
        socket.on('drone', function (data) {
            if (data.battery != undefined) {
                $('#drone-position .battery').text(data.battery)
            }
        })

        socket.on('frameReceived', function (data) {
            img.src = "frame/frame" + data + ".png";

            img.onload = function () {
                context.save();
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.globalAlpha = 1;
                context.drawImage(img, 0, 0);
                calculate(img);
            }
        })

        function calculate(img) {
            var tracker = new tracking.ColorTracker(['cyan']);
            tracker.on('track', function (event) {

                event.data.forEach(function (rect) {

                    console.log(rect);
                    window.plot(rect.x, rect.y, rect.width, rect.height, rect.color);
                });
            });
            tracking.track('#img', tracker);
        }


        window.plot = function (x, y, w, h, color) {
            var rect = document.createElement('div');
            document.getElementById('pngStream').appendChild(rect);
            rect.classList.add('rect');
            rect.style.border = '2px solid ' + color;
            rect.style.width = w + 'px';
            rect.style.height = h + 'px';
            rect.style.left = (img.offsetLeft + x) + 'px';
            rect.style.top = (img.offsetTop + y) + 'px';
        };
    })
</script>
</body>
</html>
